<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Viewer</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .table-name {
            color: #4CAF50;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Table: <span class="table-name" id="tableName">-</span></h1>
        
        <div class="button-group">
            <button class="view-btn" onclick="loadTableData()">Refresh</button>
            <button class="view-btn" onclick="window.location.href='tables.php'">Back to Tables</button>
        </div>
        
        <div id="message"></div>
        <div id="rowCount" class="record-count"></div>
        <div id="tableContent" class="table-wrapper"></div>
    </div>

    <script>
        // Get table name from URL hash
        function getTableNameFromHash() {
            const hash = window.location.hash;
            return hash ? hash.substring(1) : null;
        }
        
        // Display message
        function showMessage(message, type = 'error') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'message ' + type;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Clear message
        function clearMessage() {
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'none';
        }
        
        // Show loading state
        function showLoading() {
            document.getElementById('tableContent').innerHTML = '<div class="loading">Loading...</div>';
        }
        
        // Load table data
        async function loadTableData() {
            const tableName = getTableNameFromHash();
            
            if (!tableName) {
                showMessage('No table specified in URL hash. Use #tablename', 'error');
                return;
            }
            
            document.getElementById('tableName').textContent = tableName;
            clearMessage();
            showLoading();
            
            try {
                const response = await fetch(`api/query.php?table=${encodeURIComponent(tableName)}`);
                const data = await response.json();
                
                if (!data.success) {
                    showMessage(data.error || 'Failed to load table data', 'error');
                    document.getElementById('tableContent').innerHTML = '';
                    return;
                }
                
                displayTableData(data);
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
                document.getElementById('tableContent').innerHTML = '';
            }
        }
        
        // Display table data
        function displayTableData(data) {
            const tableContent = document.getElementById('tableContent');
            const rowCountDiv = document.getElementById('rowCount');
            
            rowCountDiv.textContent = `Total rows: ${data.count}`;
            
            if (data.count === 0) {
                tableContent.innerHTML = '<div class="no-data">No data in this table</div>';
                return;
            }
            
            // Get column names from first row
            const columns = Object.keys(data.data[0]);
            
            // Build table HTML
            let html = '<table><thead><tr>';
            
            // Add column headers
            columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '<th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            // Add data rows
            data.data.forEach((row, index) => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col] !== null ? row[col] : '<em>NULL</em>';
                    html += `<td>${escapeHtml(String(value))}</td>`;
                });
                
                // Add delete button
                html += `<td><button class="delete-btn" onclick="deleteRow(${index})">Delete</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            tableContent.innerHTML = html;
            
            // Store data for delete operations
            window.currentTableData = data.data;
        }
        
        // Delete a row
        async function deleteRow(rowIndex) {
            const tableName = getTableNameFromHash();
            if (!tableName) {
                showMessage('No table specified', 'error');
                return;
            }
            
            const rowData = window.currentTableData[rowIndex];
            
            if (!confirm(`Are you sure you want to delete this row?`)) {
                return;
            }
            
            try {
                // Build form data from row data
                const formData = new FormData();
                for (const [key, value] of Object.entries(rowData)) {
                    if (value !== null) {
                        formData.append(key, value);
                    }
                }
                
                const response = await fetch(`api/delete.php?table=${encodeURIComponent(tableName)}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Row deleted successfully!', 'success');
                    // Reload table data
                    setTimeout(() => loadTableData(), 500);
                } else {
                    showMessage(result.error || 'Failed to delete row', 'error');
                }
                
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load data when page loads
        window.addEventListener('load', loadTableData);
        
        // Reload data when hash changes
        window.addEventListener('hashchange', loadTableData);
    </script>
</body>
</html>