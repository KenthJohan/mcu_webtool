<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCU Flash Page Viewer (2kB)</title>
    <link rel="stylesheet" href="parinspect.css">
</head>
<body>
    <h1>MCU Flash Page Viewer (2kB - 64x32 Grid)</h1>
    
    <div class="container">
        <div class="left-panel">
            <h2>Add Parameter</h2>
            <form id="parameterForm">
                <div class="form-group">
                    <label>Parameter Name:</label>
                    <input type="text" id="paramName" name="name" required placeholder="e.g., CONFIG_TIMEOUT">
                </div>
                
                <div class="form-group">
                    <label>Type:</label>
                    <select id="paramType" name="type_id" required>
                        <option value="">Select Type</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity:</label>
                    <select id="paramQuantity" name="quantity_id">
                        <option value="">Select Quantity</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Unit:</label>
                    <select id="paramUnit" name="unit_id">
                        <option value="">Select Unit</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Array Count:</label>
                    <input type="number" id="paramCount" name="count" value="1" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>Size (bytes):</label>
                    <input type="number" id="paramSize" name="size" value="4" min="1" max="2048" required readonly>
                </div>
                
                <div class="form-group">
                    <label>Offset in Page:</label>
                    <input type="number" id="paramOffset" name="offset" value="0" min="0" max="2047" required readonly>
                </div>
                
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="paramDescription" name="description" placeholder="Parameter description"></textarea>
                </div>
                
                <button type="button" class="secondary" onclick="startSelection()">Select on Grid</button>
                <button type="submit">Add Parameter</button>
                <button type="button" class="danger" onclick="clearSelection()">Clear</button>
            </form>
            
            <div id="selectionMode" class="selection-mode" style="display: none;">
                <strong>Selection Mode Active</strong><br>
                Click and drag on the grid to select parameter location
            </div>
        </div>
        
        <div class="right-panel">
            <div id="info">
                Page Base Address: <span class="address-display">0x0800F800</span> | 
                Size: 2048 bytes (2kB) | 
                Click on grid to view address
            </div>
            <canvas id="gridCanvas"></canvas>
            <div id="cellInfo">Click on grid to see address information</div>
            
            <h3>Parameters in this Page</h3>
            <div id="parameterList">Loading...</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gridCanvas');
        const ctx = canvas.getContext('2d');
        
        // Grid configuration
        const COLS = 64;
        const ROWS = 32;
        const CELL_SIZE = 12;
        const LINE_WIDTH = 1;
        const PAGE_BASE_ADDRESS = 0x0800F800;
        
        // Canvas dimensions
        canvas.width = COLS * CELL_SIZE + LINE_WIDTH;
        canvas.height = ROWS * CELL_SIZE + LINE_WIDTH;
        
        // State
        let parameters = [];
        let selectionMode = false;
        let selectionStart = null;
        let selectionEnd = null;
        let isDragging = false;
        let hoveredParameter = null;
        
        // Color palette for parameters
        const PARAM_COLORS = [
            '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF',
            '#FFD4BA', '#E0BBE4', '#FFDFD3', '#C7CEEA', '#D4F1F4'
        ];
        
        // Get cell coordinates from mouse position
        function getCellFromMouse(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            const col = Math.floor(x / CELL_SIZE);
            const row = Math.floor(y / CELL_SIZE);
            
            if (row >= 0 && row < ROWS && col >= 0 && col < COLS) {
                return { row, col };
            }
            return null;
        }
        
        // Convert row/col to byte offset
        function cellToOffset(row, col) {
            return row * COLS + col;
        }
        
        // Convert offset to row/col
        function offsetToCell(offset) {
            return {
                row: Math.floor(offset / COLS),
                col: offset % COLS
            };
        }
        
        // Draw the grid
        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw cells
            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    const x = col * CELL_SIZE;
                    const y = row * CELL_SIZE;
                    const offset = cellToOffset(row, col);
                    
                    // Determine cell color
                    let fillColor = '#ffffff';
                    let isPartOfParam = false;
                    
                    // Check if cell is part of a parameter
                    for (let i = 0; i < parameters.length; i++) {
                        const param = parameters[i];
                        const totalSize = param.size * param.count;
                        if (offset >= param.offset && offset < param.offset + totalSize) {
                            fillColor = PARAM_COLORS[i % PARAM_COLORS.length];
                            isPartOfParam = true;
                            
                            // Highlight if hovered
                            if (hoveredParameter && hoveredParameter.id === param.id) {
                                fillColor = '#ffeb3b';
                            }
                            break;
                        }
                    }
                    
                    // Current selection
                    if (selectionMode && selectionStart && selectionEnd) {
                        const startOffset = cellToOffset(selectionStart.row, selectionStart.col);
                        const endOffset = cellToOffset(selectionEnd.row, selectionEnd.col);
                        const minOffset = Math.min(startOffset, endOffset);
                        const maxOffset = Math.max(startOffset, endOffset);
                        
                        if (offset >= minOffset && offset <= maxOffset) {
                            fillColor = '#2196F3';
                        }
                    }
                    
                    // Fill cell
                    ctx.fillStyle = fillColor;
                    ctx.fillRect(x, y, CELL_SIZE, CELL_SIZE);
                    
                    // Draw cell border
                    ctx.strokeStyle = '#cccccc';
                    ctx.lineWidth = LINE_WIDTH;
                    ctx.strokeRect(x, y, CELL_SIZE, CELL_SIZE);
                }
            }
        }
        
        // Handle mouse down
        canvas.addEventListener('mousedown', function(event) {
            if (!selectionMode) return;
            
            const cell = getCellFromMouse(event);
            if (cell) {
                isDragging = true;
                selectionStart = cell;
                selectionEnd = cell;
                updateSelectionInfo();
                drawGrid();
            }
        });
        
        // Handle mouse move
        canvas.addEventListener('mousemove', function(event) {
            const cell = getCellFromMouse(event);
            if (!cell) return;
            
            // Handle selection dragging
            if (selectionMode && isDragging) {
                selectionEnd = cell;
                updateSelectionInfo();
                drawGrid();
            } else if (!selectionMode) {
                // Handle hover to show parameter info
                const offset = cellToOffset(cell.row, cell.col);
                let foundParam = null;
                
                for (const param of parameters) {
                    const totalSize = param.size * param.count;
                    if (offset >= param.offset && offset < param.offset + totalSize) {
                        foundParam = param;
                        break;
                    }
                }
                
                if (foundParam !== hoveredParameter) {
                    hoveredParameter = foundParam;
                    drawGrid();
                    
                    if (foundParam) {
                        const address = PAGE_BASE_ADDRESS + offset;
                        document.getElementById('cellInfo').innerHTML = `
                            <strong>${foundParam.name}</strong><br>
                            Type: ${foundParam.type_name || 'N/A'} | 
                            Size: ${foundParam.size} bytes × ${foundParam.count}<br>
                            Address: <span class="address-display">0x${address.toString(16).toUpperCase().padStart(8, '0')}</span> 
                            (offset: ${offset})<br>
                            ${foundParam.quantity_name ? 'Quantity: ' + foundParam.quantity_name : ''} 
                            ${foundParam.unit_symbol ? '(' + foundParam.unit_symbol + ')' : ''}<br>
                            ${foundParam.description || ''}
                        `;
                    } else {
                        const address = PAGE_BASE_ADDRESS + offset;
                        document.getElementById('cellInfo').innerHTML = `
                            Offset: ${offset} (0x${offset.toString(16).toUpperCase().padStart(4, '0')})<br>
                            Address: <span class="address-display">0x${address.toString(16).toUpperCase().padStart(8, '0')}</span><br>
                            <em>No parameter at this location</em>
                        `;
                    }
                }
            }
        });
        
        // Handle mouse up
        canvas.addEventListener('mouseup', function(event) {
            if (selectionMode && isDragging) {
                isDragging = false;
            }
        });
        
        // Update selection info
        function updateSelectionInfo() {
            if (!selectionStart || !selectionEnd) return;
            
            const startOffset = cellToOffset(selectionStart.row, selectionStart.col);
            const endOffset = cellToOffset(selectionEnd.row, selectionEnd.col);
            const minOffset = Math.min(startOffset, endOffset);
            const maxOffset = Math.max(startOffset, endOffset);
            const size = maxOffset - minOffset + 1;
            
            document.getElementById('paramOffset').value = minOffset;
            document.getElementById('paramSize').value = size;
            
            // Update count if type is selected
            updateSize();
        }
        
        // Start selection mode
        function startSelection() {
            selectionMode = true;
            selectionStart = null;
            selectionEnd = null;
            document.getElementById('selectionMode').style.display = 'block';
            canvas.style.cursor = 'crosshair';
            drawGrid();
        }
        
        // Clear selection
        function clearSelection() {
            selectionMode = false;
            selectionStart = null;
            selectionEnd = null;
            isDragging = false;
            document.getElementById('selectionMode').style.display = 'none';
            canvas.style.cursor = 'pointer';
            document.getElementById('parameterForm').reset();
            drawGrid();
        }
        
        // Update size based on type and count
        function updateSize() {
            const typeSelect = document.getElementById('paramType');
            const countInput = document.getElementById('paramCount');
            const sizeInput = document.getElementById('paramSize');
            
            if (typeSelect.selectedIndex > 0) {
                const selectedOption = typeSelect.options[typeSelect.selectedIndex];
                const typeSize = parseInt(selectedOption.dataset.size);
                const count = parseInt(countInput.value) || 1;
                sizeInput.value = typeSize * count;
            }
        }
        
        // Load parameters from database
        function loadParameters() {
            fetch('api/query.php?table=mcu_parameters')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Filter parameters by page address range
                    const page_base = PAGE_BASE_ADDRESS;
                    const page_size = 2048;
                    
                    parameters = data.data
                        .filter(p => p.address >= page_base && p.address < page_base + page_size)
                        .map(p => {
                            // Calculate offset
                            p.offset = p.address - page_base;
                            return p;
                        })
                        .sort((a, b) => a.address - b.address);
                    
                    // Fetch additional data (types, quantities, units) for each parameter
                    Promise.all([
                        fetch('api/query.php?table=types').then(r => r.json()),
                        fetch('api/query.php?table=quantities').then(r => r.json()),
                        fetch('api/query.php?table=units').then(r => r.json())
                    ]).then(([typesData, quantitiesData, unitsData]) => {
                        const types = typesData.success ? typesData.data : [];
                        const quantities = quantitiesData.success ? quantitiesData.data : [];
                        const units = unitsData.success ? unitsData.data : [];
                        
                        // Enrich parameters with related data
                        parameters.forEach(param => {
                            const type = types.find(t => t.id === param.fk_type);
                            const quantity = quantities.find(q => q.id === param.fk_quantity);
                            const unit = units.find(u => u.id === param.fk_unit);
                            
                            param.type_name = type ? type.type_name : null;
                            param.quantity_name = quantity ? quantity.quantity_name : null;
                            param.unit_symbol = unit ? unit.unit_symbol : null;
                        });
                        
                        displayParameters();
                        drawGrid();
                    });
                } else {
                    console.error('Failed to load parameters:', data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        // Display parameters in list
        function displayParameters() {
            const list = document.getElementById('parameterList');
            
            if (parameters.length === 0) {
                list.innerHTML = '<em style="color: #999;">No parameters in this page yet</em>';
                return;
            }
            
            list.innerHTML = parameters.map((param, index) => {
                const color = PARAM_COLORS[index % PARAM_COLORS.length];
                const address = PAGE_BASE_ADDRESS + param.offset;
                const totalSize = param.size * param.count;
                
                return `
                    <div class="parameter-item" style="border-color: ${color};" 
                         onmouseover="highlightParameter(${param.id})" 
                         onmouseout="unhighlightParameter()">
                        <strong>${param.name}</strong>
                        Address: <span class="address-display">0x${address.toString(16).toUpperCase().padStart(8, '0')}</span><br>
                        Offset: ${param.offset}-${param.offset + totalSize - 1} (${totalSize} bytes)<br>
                        Type: ${param.type_name || 'N/A'} × ${param.count}
                        ${param.unit_symbol ? ' [' + param.unit_symbol + ']' : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Highlight parameter on grid
        function highlightParameter(paramId) {
            hoveredParameter = parameters.find(p => p.id == paramId);
            drawGrid();
        }
        
        function unhighlightParameter() {
            hoveredParameter = null;
            drawGrid();
        }
        
        // Handle form submission
        document.getElementById('parameterForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            formData.append('action', 'add_parameter');
            
            fetch('', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Parameter added successfully!');
                    clearSelection();
                    loadParameters();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        });
        
        // Load dropdown data
        function loadDropdowns() {
            // Load types
            fetch('api/query.php?table=types')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const typeSelect = document.getElementById('paramType');
                    data.data.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.dataset.size = type.size_bytes;
                        option.textContent = `${type.type_name} (${type.size_bytes} bytes)`;
                        typeSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading types:', error));
            
            // Load quantities
            fetch('api/query.php?table=quantities')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const quantitySelect = document.getElementById('paramQuantity');
                    data.data.forEach(qty => {
                        const option = document.createElement('option');
                        option.value = qty.id;
                        option.textContent = qty.quantity_name;
                        quantitySelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading quantities:', error));
            
            // Load units
            fetch('api/query.php?table=units')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const unitSelect = document.getElementById('paramUnit');
                    data.data.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.id;
                        const unitText = unit.unit_symbol + (unit.unit_name ? ` (${unit.unit_name})` : '');
                        option.textContent = unitText;
                        unitSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading units:', error));
        }
        
        // Event listeners for form updates
        document.getElementById('paramType').addEventListener('change', updateSize);
        document.getElementById('paramCount').addEventListener('input', updateSize);
        
        // Initial load
        loadDropdowns();
        loadParameters();
        drawGrid();
    </script>
</body>
</html>
